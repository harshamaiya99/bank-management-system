name: "Generate Allure Report"
description: "Generates Allure 3 report with history"
inputs:
  github_run_number:
    required: true
  github_run_id:
    required: true
  github_repository:
    required: true
  github_repository_owner:
    required: true
  github_repo_name:
    required: true
runs:
  using: "composite"
  steps:
    - name: Add Allure Metadata
      if: always()
      shell: bash
      run: |
        # Create environment.properties for Allure
        cat > tests/reports/allure-results/environment.properties << EOF
        Project=Bank Management System
        Environment=GitHub Actions (CI)
        Executor=GitHub Actions
        Build.Number=${{ inputs.github_run_number }}
        Build.URL=https://github.com/${{ inputs.github_repository }}/actions/runs/${{ inputs.github_run_id }}
        Repository=${{ inputs.github_repository }}
        Branch=${GITHUB_REF##*/}
        Commit=${GITHUB_SHA:0:7}
        EOF
        
        # Create executor.json for Allure
        cat > tests/reports/allure-results/executor.json << EOF
        {
          "name": "GitHub Actions",
          "type": "github",
          "url": "https://github.com/${{ inputs.github_repository }}",
          "buildOrder": ${{ inputs.github_run_number }},
          "buildName": "Run #${{ inputs.github_run_number }}",
          "buildUrl": "https://github.com/${{ inputs.github_repository }}/actions/runs/${{ inputs.github_run_id }}",
          "reportName": "Allure Report"
        }
        EOF

    - name: Generate Allure Report (Allure 3 with History)
      if: always()
      shell: bash
      run: |
        # Remove old report if exists
        rm -rf tests/reports/allure-report
        
        # Check if history file exists
        if [ -f "tests/reports/history.jsonl" ]; then
          echo "Found history file with $(wc -l < tests/reports/history.jsonl) run(s)"
          # Generate with history
          allure generate tests/reports/allure-results \
            --output tests/reports/allure-report \
            --report-name "Bank Management Test Report" \
            --history-path tests/reports/history.jsonl \
            --history-limit 20
        else
          echo "No history file found, generating first report"
          # Generate without history (first run)
          allure generate tests/reports/allure-results \
            --output tests/reports/allure-report \
            --report-name "Bank Management Test Report"
        fi
        
        echo "Allure report generated successfully"

    - name: Combine into Single HTML
      if: always()
      shell: bash
      run: |
        if [ -d "tests/reports/allure-report" ]; then
          allure-combine tests/reports/allure-report
          echo "Report combined into single HTML file"
        else
          echo "Report directory not found, skipping combine step"
          exit 1
        fi