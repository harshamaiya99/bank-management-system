name: Automated Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  schedule:
    - cron: "30 18 * * *"

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      BASE_URL: http://127.0.0.1:9000
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      CLERK_USERNAME: ${{ secrets.CLERK_USERNAME }}
      CLERK_PASSWORD: ${{ secrets.CLERK_PASSWORD }}
      MANAGER_USERNAME: ${{ secrets.MANAGER_USERNAME }}
      MANAGER_PASSWORD: ${{ secrets.MANAGER_PASSWORD }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # --- 1. SETUP ---
    - name: Setup Environment
      uses: ./.github/actions/setup-env

    # --- 2. HISTORY (Restore history.jsonl) ---
    - name: Restore History
      uses: ./.github/actions/restore-history

    # --- 3. TEST ---
    - name: Run Tests
      uses: ./.github/actions/run-tests

    # --- 4. REPORT ---
    - name: Generate Report
      if: always()
      uses: ./.github/actions/generate-report
      with:
        github_run_number: ${{ github.run_number }}
        github_run_id: ${{ github.run_id }}
        github_repository: ${{ github.repository }}
        github_repository_owner: ${{ github.repository_owner }}
        github_repo_name: ${{ github.event.repository.name }}

    # --- 5. PUBLISH (Save history.jsonl to branch) ---
    - name: Save History to Branch
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: allure-history
        publish_dir: tests/reports
        # Only include history.jsonl file
        include: history.jsonl
        keep_files: false

    - name: Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: tests/reports/allure-report/
        retention-days: 15

    - name: Upload Karate Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: karate-reports
        path: tests/api_karate/target/karate-reports/
        retention-days: 15