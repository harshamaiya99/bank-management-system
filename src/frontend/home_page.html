<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bank Account Management</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="color: var(--primary-color); margin: 0;">Bank Management System</h1>
            <button class="btn-cancel" onclick="logout()" style="padding: 8px 15px; font-size: 14px;">Logout</button>
        </div>

        <p style="text-align:right; color: #666; margin-bottom: 30px;">
            Logged in as: <strong id="userDisplay">...</strong>
        </p>

        <div class="form-section">
            <h3 class="section-title">Search Account</h3>
            <div class="form-row" style="align-items: flex-end;">
                <div class="form-group" style="flex: 3;">
                    <label>Account ID</label>
                    <input
                        type="text"
                        id="accountId"
                        placeholder="Enter 7-digit Account ID"
                        maxlength="7"
                        pattern="[0-9]{7}"
                    >
                </div>
                <div class="form-group" style="flex: 1;">
                    <button class="btn-search" onclick="searchAccount()" style="width: 100%;">Search Account</button>
                </div>
            </div>
            <div id="errorMessage" style="color: #dc3545; font-size: 14px; margin-top: -10px;"></div>
        </div>

        <div class="form-section" >
            <h3 class="section-title">Create Account</h3>
            <div class="form-row" style="align-items: flex-end;">
                <div class="form-group" style="flex: 3;">
                    <p>Open a new savings, current or salary account.</p>
                </div>
                <div class="form-group" style="flex: 1;">
                    <button class="btn-create" onclick="goToCreateAccount()" style="width: 100%; max-width: 300px;">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = "{{ base_url }}";
        const token = localStorage.getItem("token");
        const user = localStorage.getItem("user");

        if (!token) {
            window.location.href = "/login.html";
        }
        document.getElementById("userDisplay").textContent = user || "Staff";

        async function authFetch(url, options = {}) {
            const headers = {
                ...options.headers,
                "Authorization": `Bearer ${token}`
            };

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401) {
                alert("Session expired. Please login again.");
                logout();
                return null;
            }
            if (response.status === 403) {
                alert("Permission Denied.");
                return null;
            }
            return response;
        }

        function logout() {
            localStorage.clear();
            window.location.href = "/login.html";
        }

        async function searchAccount() {
            const accountId = document.getElementById("accountId").value.trim();
            const errorMsg = document.getElementById("errorMessage");

            errorMsg.textContent = "";

            if (accountId.length !== 7 || !/^\d{7}$/.test(accountId)) {
                errorMsg.textContent = "Please enter a valid 7-digit account ID";
                return;
            }

            const res = await authFetch(`${BASE_URL}/accounts/${accountId}`);

            if (res && res.ok) {
                window.location.href = `/accountDetails.html?account_id=${accountId}`;
            } else if (res && res.status === 404) {
                errorMsg.textContent = "Account not found.";
            }
        }

        function goToCreateAccount() {
            window.location.href = "/createAccount.html";
        }

        document.getElementById("accountId").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                searchAccount();
            }
        });
    </script>
</body>
</html>